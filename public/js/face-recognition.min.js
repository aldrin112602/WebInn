$(document).ready(function(){let e=!1,t=0,n=null,i=!1,r=!0,a=[{instruction:"Please look at the camera",action:"center",progress:25},{instruction:"Turn your head to the left",action:"right",progress:50},{instruction:"Turn your head to the right",action:"left",progress:75},{instruction:"Verification complete!",action:"complete",progress:100}],o=$("#video")[0],s=$("#student-name"),c=$("#student-strand"),l=$("#student-gender"),u=$("#student-id"),d=$("#time-in"),h=$("#resetButton"),g=$("#overlay")[0],f=$("#progress-bar"),m=$("#loading-overlay"),p=$("#timeToggle"),y=$("#time-type");async function w(){try{m.show(),await Promise.all([faceapi.nets.tinyFaceDetector.loadFromUri('{{ asset("face_api/models") }}'),faceapi.nets.faceLandmark68Net.loadFromUri('{{ asset("face_api/models") }}'),faceapi.nets.faceRecognitionNet.loadFromUri('{{ asset("face_api/models") }}')]),n=await x(),await navigator.mediaDevices.getUserMedia({video:{}}).then(e=>(o.srcObject=e,new Promise(e=>{o.onloadedmetadata=()=>{g.width=o.videoWidth,g.height=o.videoHeight,e()}}))),m.hide(),i=!0}catch(e){console.error("Initialization error:",e),m.hide(),Swal.fire({title:"Error",text:"Failed to initialize face recognition system. Please refresh the page.",icon:"error"})}}async function x(){try{let e=await $.get('{{ route("fetch_labels") }}'),t=await Promise.all(e.map(async e=>{let t=[];for(let n=0;n<3;n++){let i=await faceapi.fetchImage(`{{ asset('storage/face_images/') }}/${e}/${n}.jpg`),r=await faceapi.detectSingleFace(i,new faceapi.TinyFaceDetectorOptions).withFaceLandmarks().withFaceDescriptor();r&&t.push(r.descriptor)}return new faceapi.LabeledFaceDescriptors(e,t)}));return new faceapi.FaceMatcher(t,.4)}catch(n){throw console.error("Error initializing face matcher:",n),n}}function F(){++t<a.length&&($("#instruction").text(a[t].instruction),f.css("width",a[t].progress+"%"))}function k(e){let t=e.reduce((e,t)=>({x:e.x+t.x,y:e.y+t.y}),{x:0,y:0});return{x:t.x/e.length,y:t.y/e.length}}p.on("change",function(){r=$(this).is(":checked"),y.text(r?"In":"Out")}),$(o).on("play",async()=>{let t={width:o.videoWidth,height:o.videoHeight};async function a(){if(!i)return requestAnimationFrame(a);let h=await faceapi.detectAllFaces(o,new faceapi.TinyFaceDetectorOptions).withFaceLandmarks().withFaceDescriptors();if(0===h.length)return requestAnimationFrame(a);let f=h[0].landmarks;if(f.getJawOutline(),f.getNose(),!e){let m=n.findBestMatch(h[0].descriptor);"unknown"!==m.label?($("#instruction").text(m.label),e||function t(n){$.get(`/face_recognition/student-info/${n}`,t=>{let{id:n,name:i,strand:a,gender:o,id_number:h}=t;l.text(o),s.text(i),c.text(a),u.text(h),d.text(function e(){let t=new Date,n=String(t.getDate()).padStart(2,"0"),i=String(t.getMonth()+1).padStart(2,"0"),r=t.getFullYear();return`${n}-${i}-${r}`}()+" "+function e(){let t=new Date,n=t.getHours()>12?t.getHours()-12:t.getHours(),i=String(t.getMinutes()).padStart(2,"0");return`${n}:${i}${t.getHours()>=12?" PM":" AM"}`}()),e||($.ajax({url:'{{ route("face.attendance") }}',type:"POST",data:{student_id:n,is_time_in:String(r)},headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")},success:function(t){e=!0,console.log(t),Swal.fire({title:t.success?"Face Successfully Scanned!":"Info!",text:t.message,icon:t.success?"success":"info"})},error:function(t){e=!0,console.error("Error submitting attendance:",t),Swal.fire({title:"Error",text:"Failed to submit attendance. Please try again.",icon:"error"})}}),e=!0)}).fail(e=>{console.error("Error fetching student info:",e),Swal.fire({title:"Error",text:"Failed to fetch student information. Please try again.",icon:"error"})})}(m.label)):$("#instruction").text("Unknown")}faceapi.resizeResults(h,t);let p=g.getContext("2d");p.clearRect(0,0,g.width,g.height),requestAnimationFrame(a)}faceapi.matchDimensions(g,t),a()}),h.on("click",()=>{e=!1,t=0,$("#instruction").text(a[0].instruction),f.css("width","0%"),s.text("N/A"),c.text("N/A"),l.text("N/A"),u.text("N/A"),d.text("N/A"),p.prop("checked",!0),r=!0,y.text("In"),Swal.fire({title:"Face Scan Reset successfully",icon:"success"})}),window.addEventListener("beforeunload",function(e){var t="Are you sure to reload this page? This may take some time to load all models once you reload the page.";return(e||window.event).returnValue=t,t}),w()});